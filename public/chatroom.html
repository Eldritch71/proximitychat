<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Proximity Chat</title>
        <style>
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body { font: 13px Helvetica, Arial; }
                form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
                form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
                form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
                #messages { list-style-type: none; margin: 0; padding: 0; }
                #messages li { padding: 5px 10px; }
                #messages li:nth-child(odd) { background: #eee; }
        </style>
    </head>
    <body>
        <ul id="messages"></ul>
        <form action="" id="f">
            <input id="m" autocomplete="off"/><button>Send</button>
        </form>
        <script src="/socket.io/socket.io.js"></script>
        <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
        <script>
            var user = {};
            var usersCount, messagesList, messageBox, sendButton, socket;

            window.onload = start;

            function start(){
                user.name = "user";

                socket = io.connect(window.location.host);

                /*set variables listed above*/
                usersCount = 0;
                messagesList = document.getElementById("messages");
                messageBox = document.getElementById("m");
                sendButton = document.getElementById("f");

                /*setup basic function listeners*/
                socket.on('user connected', addUser);
                socket.on('user disconnected', removeUser);
                socket.on('message to clients', receiveChatMessage);
                socket.on('decline message', declineAlert);

                sendButton.submit(sendChatMessage);

                var userName = {name : user.name};

                /*confirm that user has joined*/
                socket.emit('join', userName, function(key){
                    user.key = key;
                });

                testGeo();
            };


            function testGeo(){
                if(navigator.geolocation){
                    alert("browser supports geolocation");

                /*confirm that geolocation is enabled by user.  If not, throw error*/
                navigator.geolocation.getCurrentPosition(function(p){
                    alert("geolocation enabled");

                    /*set a listener for location requests*/
                    socket.on('request location', sendLocation);
                }, showError(error));

                /*send alert if geolocation not supported by browser*/
                } else {
                    alert("Geolocation is not supported by this broswer");
                }
            }

            function addUser (user){
                ++usersCount;
            }

            function removeUser (user){
                --usersCount;
            }

            function receiveChatMessage (data){
                messagesList.append(data.message);
            }

            function sendChatMessage(){
                sendLocation();
                socket.emit('message to server', messageBox.val());
                messageBox.val('');
            }

            function declineAlert(msg){
                alert(msg);
            }


            function sendLocation(){
                alert("1");
                if(navigator.geolocation){
                    alert("2");
                    navigator.geolocation.getCurrentPosition(function(position){
                        alert("3");
                        var data = {lat : position.coords.latitude, lng : position.coords.longitude };
                        socket.emit('send location', data);
                    }, showError(error));
                } else {
                    alert("Geolocation is not supported by this broswer");
                }
            }

            function showError(error) {
                alert("there was an error");
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        alert("User denied the request for Geolocation.");
                        break;
                    case error.POSITION_UNAVAILABLE:
                        alert("Location information is unavailable.");
                        break;
                    case error.TIMEOUT:
                        alert("The request to get user location timed out.");
                        break;
                    case error.UNKNOWN_ERROR:
                        alert("An unknown error occurred.");
                        break;
                }
            }
        </script>
        <!--<script src="./SocketClient.js"></script>-->
    </body>
</html>
